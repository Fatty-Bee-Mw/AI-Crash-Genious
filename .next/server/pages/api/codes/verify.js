"use strict";(()=>{var e={};e.id=111,e.ids=[111],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,n){return n in t?t[n]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,n)):"function"==typeof t&&"default"===n?t:void 0}}})},9269:(e,t,n)=>{n.r(t),n.d(t,{config:()=>l,default:()=>c,routeModule:()=>f});var r={};n.r(r),n.d(r,{default:()=>a});var i=n(1802),o=n(7153),s=n(6249),u=n(2600);let d=new Map;function a(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});if(!String(e.headers["content-type"]||"").toLowerCase().includes("application/json"))return t.status(400).json({error:"invalid content-type"});let n=String(e.headers.origin||""),r=String(e.headers.referer||""),i=String(e.headers.host||""),o=[`https://${i}`,`http://${i}`];if(n&&!o.some(e=>n.startsWith(e))||r&&!o.some(e=>r.startsWith(e)))return t.status(400).json({error:"bad origin"});let{code:s,deviceId:a}=e.body||{};if(!s||!a)return t.status(400).json({error:"code and deviceId required"});if(!/^[a-f0-9]{32}$/i.test(a))return t.status(400).json({error:"invalid deviceId format"});let c=String(s).toUpperCase().replace(/[^A-Z0-9]/g,"");if(!/^[A-Z2-9]{8,24}$/.test(c))return t.status(400).json({error:"invalid code"});let l=e.headers["x-forwarded-for"]?.split(",")[0]||e.socket.remoteAddress||"unknown",f=`${a}:${l}`,p=Date.now(),h=d.get(f)||{count:0,ts:p,lockedUntil:0};if(h.lockedUntil&&p<h.lockedUntil)return t.status(429).json({error:"locked",retryAfterMs:h.lockedUntil-p});p-h.ts>6e5&&(h.count=0,h.ts=p,h.lockedUntil=0);let P=(0,u.VP)({code:c,deviceId:a});return P.ok?(d.delete(f),t.status(200).json({ok:!0})):(h.count+=1,h.ts=p,h.count>=10&&(h.lockedUntil=p+18e5,h.count=0),d.set(f,h),t.status(400).json(P))}let c=(0,s.l)(r,"default"),l=(0,s.l)(r,"config"),f=new i.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/codes/verify",pathname:"/api/codes/verify",bundlePath:"",filename:""},userland:r})},2600:(e,t,n)=>{n.d(t,{hP:()=>v,TZ:()=>s,oP:()=>d,_5:()=>S,vM:()=>h,Bu:()=>c,iY:()=>f,TC:()=>g,SW:()=>u,wd:()=>P,I7:()=>p,Yn:()=>m,bY:()=>A,VP:()=>l});let r=require("crypto");var i=n.n(r);let o={requests:[],codes:{},recipients:[]};function s({provider:e,msisdn:t,imageBase64:n,deviceId:r}){let i={id:Math.random().toString(36).slice(2,10).toUpperCase(),createdAt:Date.now(),provider:e||null,msisdn:t||null,imageBase64:n,deviceId:r,status:"pending",notes:""};return o.requests.unshift(i),i}function u(){return o.requests}function d(e){let t=o.requests.findIndex(t=>t.id===e);return -1===t?null:(o.requests[t].status="approved",o.requests[t])}function a(e){return i().createHash("sha256").update(e,"utf8").digest("hex")}function c({deviceId:e,ttlMs:t}){let n=function(e=16){let t="ABCDEFGHJKLMNPQRSTUVWXYZ23456789",n=i().randomBytes(e),r="";for(let i=0;i<e;i++)r+=t[n[i]%t.length];return r}(16),r=a(n),s=Date.now()+t;return o.codes[r]={deviceId:e,expiresAt:s},{code:n,codeId:r,expiresAt:s}}function l({code:e,deviceId:t}){let n=a(String(e||"")),r=o.codes[n];return r?r.deviceId!==t?{ok:!1,reason:"Different device"}:r.expiresAt<Date.now()?{ok:!1,reason:"Expired"}:{ok:!0}:{ok:!1,reason:"Code not found"}}function f(){return Object.entries(o.codes).map(([e,t])=>({codeId:e,...t}))}function p(e){let t=o.codes[e]?e:a(String(e||""));return!!o.codes[t]&&(delete o.codes[t],!0)}function h(){return{requests:o.requests,codes:o.codes,recipients:o.recipients,exportedAt:Date.now(),version:1}}function P(e){if(!e||"object"!=typeof e)return!1;let{requests:t,codes:n,recipients:r}=e;return!!Array.isArray(t)&&"object"==typeof n&&(o.requests=t,o.codes=n,o.recipients=Array.isArray(r)?r:[],!0)}function A(e,t){let n=o.requests.find(t=>t.id===e);return n?(n.notes=String(t||"").slice(0,2e3),n):null}function g(){return o.recipients}function v(e){let t={id:Math.random().toString(36).slice(2,10),phone:String(e||"").trim(),enabled:!0,createdAt:Date.now()};return o.recipients.unshift(t),t}function m(e,t){let n=o.recipients.findIndex(t=>t.id===e);if(-1===n)return null;let r={...o.recipients[n]};return t&&"object"==typeof t&&(null!=t.phone&&(r.phone=String(t.phone).trim()),null!=t.enabled&&(r.enabled=!!t.enabled)),o.recipients[n]=r,r}function S(e){let t=o.recipients.findIndex(t=>t.id===e);return -1!==t&&(o.recipients.splice(t,1),!0)}},7153:(e,t)=>{var n;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return n}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(n||(n={}))},1802:(e,t,n)=>{e.exports=n(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var n=t(t.s=9269);module.exports=n})();